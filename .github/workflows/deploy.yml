name: Deploy to Render

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          echo "Triggering Render deployment..."
          
          # Get all services
          SERVICES=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
            "https://api.render.com/v1/services" | \
            jq -r '.[] | select(.service.name | startswith("server-dashboard")) | .service.id')
          
          # Trigger deploy for each service
          for SERVICE_ID in $SERVICES; do
            echo "Deploying service: $SERVICE_ID"
            curl -X POST -H "Authorization: Bearer $RENDER_API_KEY" \
              "https://api.render.com/v1/services/$SERVICE_ID/deploys"
          done
          
          echo "Deployment triggered successfully!"

      - name: Deployment Status
        run: echo "Check deployment status at https://dashboard.render.com"
